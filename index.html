<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>커피쏘기</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; display: flex; flex-direction: column; align-items: center; }
    .section { margin: 20px 0; width: 90%; max-width: 800px; position: relative; text-align: center; }
    .roulette { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    canvas { display: block; margin: 30px auto; cursor: pointer; transition: transform 0.3s ease-out; }
    .winner-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      z-index: 100;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .hidden { display: none; }
    .firework { position: absolute; width: 100vw; height: 100vh; top: 0; left: 0; pointer-events: none; z-index: 99; }
    .group-box {
      border: 2px solid #ccc;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      background: #fff;
    }
    .input-group {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
    }
    .input-group input {
      font-size: 16px;
      padding: 12px 16px;
      border-radius: 9999px;
      border: 2px solid #000;
      outline: none;
      height: 50px;
      width: 120px;
    }
    .input-group button {
      font-size: 16px;
      padding: 12px 20px;
      border-radius: 9999px;
      border: none;
      background-color: #000;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
      height: 50px;
    }
    .input-group button:hover {
      background-color: #333;
    }
    .menu-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 10px 0;
      justify-content: center;
    }
    .menu-item {
      background: #e0e0e0;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
    }
    .pointer {
      position: relative;
      margin: 0 auto 10px auto;
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 25px solid #333;
      z-index: 10;
    }
    button {
      font-size: 16px;
      padding: 12px 20px;
      cursor: pointer;
      margin-top: 20px;
      border-radius: 9999px;
      border: none;
      background-color: #000;
      color: #fff;
      font-weight: bold;
      transition: background-color 0.2s ease;
      height: 50px;
    }
    button:hover {
      background-color: #333;
    }
  </style>
</head>
<body>
  <div class="section roulette">
    <h2>커피쏘기</h2>
    <div class="group-box">
      <div class="input-group">
        <input type="text" id="menuInput" placeholder="참가자명 입력">
        <button onclick="addMenu()">추가</button>
      </div>
      <div class="menu-list" id="menuList"></div>
    </div>
    <div class="group-box">
      <div class="pointer"></div>
      <canvas id="rouletteCanvas" width="400" height="400"></canvas>
      <button onclick="spinRoulette()">돌리기</button>
    </div>
  </div>

  <div id="popup" class="winner-popup hidden"></div>
  <div id="firework" class="firework hidden"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    let rouletteItems = JSON.parse(localStorage.getItem('rouletteItems') || '[]');
    const canvas = document.getElementById('rouletteCanvas');
    const ctx = canvas.getContext('2d');
    const menuList = document.getElementById('menuList');
    
    // 각 구역의 정보를 저장할 배열
    let segments = [];

    function drawRoulette() {
      const total = rouletteItems.length;
      const angle = Math.PI * 2 / total;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      menuList.innerHTML = '';
      
      // 구역 정보 초기화
      segments = [];

      // 0번 인덱스가 12시 방향(0도)에 오도록 조정
      const offset = -Math.PI / 2; // 12시 방향을 0도로 맞추기 위한 오프셋

      rouletteItems.forEach((item, i) => {
        // 각 파이의 시작 각도 (라디안)
        const startAngle = i * angle + offset;
        const endAngle = (i + 1) * angle + offset;
        const midAngle = (startAngle + endAngle) / 2;
        
        // 중앙 각도를 도 단위로 변환 (0~360도, 12시가 0도, 시계방향으로 증가)
        let midDegrees = (midAngle * 180 / Math.PI + 360) % 360;
        
        // 각 구역의 정보 저장
        segments.push({
          index: i,
          name: item,
          startAngle: startAngle,
          endAngle: endAngle,
          midAngle: midAngle,
          midAngleDegrees: midDegrees
        });

        // 파이 그리기
        ctx.beginPath();
        ctx.moveTo(200, 200);
        ctx.arc(200, 200, 200, startAngle, endAngle);
        ctx.fillStyle = `hsl(${i * 360 / total}, 80%, 70%)`;
        ctx.fill();

        // 텍스트 그리기
        ctx.save();
        ctx.translate(200, 200);
        ctx.rotate(midAngle);
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '16px sans-serif';
        ctx.fillText(item, 120, 0);
        ctx.restore();

        // 메뉴 리스트에 추가
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.textContent = `[${i + 1}] ${item}`;
        div.onclick = () => { rouletteItems.splice(i, 1); localStorage.setItem('rouletteItems', JSON.stringify(rouletteItems)); drawRoulette(); };
        menuList.appendChild(div);
      });

      // 디버깅을 위해 각 구역 정보 출력
      console.log('Segments:', segments);
    }

    function addMenu() {
      const input = document.getElementById('menuInput');
      if (input.value) {
        rouletteItems.push(input.value);
        localStorage.setItem('rouletteItems', JSON.stringify(rouletteItems));
        input.value = '';
        drawRoulette();
      }
    }

    function spinRoulette() {
      const total = rouletteItems.length;
      if (!total) return;
      
      // 참가자 목록 표시
      let participantList = '참가자 목록:\n';
      rouletteItems.forEach((item, index) => {
        participantList += `[${index + 1}] ${item}\n`;
      });
      alert(participantList);

      // 랜덤으로 당첨자 선택 (0부터 시작)
      const selectedIndex = Math.floor(Math.random() * total);
      const selectedItem = rouletteItems[selectedIndex];
      alert(`당첨자 선택 완료!\n인덱스: [${selectedIndex + 1}]\n이름: ${selectedItem}`);
      
      // 저장된 구역 정보에서 목표 각도 가져오기
      const targetSegment = segments[selectedIndex];
      // 목표 각도는 해당 세그먼트의 중앙이 12시 방향(0도)에 오도록 설정
      const targetAngle = (360 - targetSegment.midAngleDegrees) % 360;
      
      // 현재 회전 상태 가져오기 (0~360도로 정규화)
      const currentRotation = ((parseInt(canvas.style.transform.replace(/[^0-9.-]/g, '') || 0) % 360 + 360) % 360);
      
      // 몇 바퀴 돌릴지 결정 (5바퀴)
      const spinCount = 5;
      
      // 목표 각도까지의 차이 계산 (시계방향으로 계산)
      let diff = (targetAngle - currentRotation + 360) % 360;
      
      // 총 회전 각도 계산 (5바퀴 + 목표 각도까지의 회전)
      const totalRotation = currentRotation + 360 * spinCount + diff;
      
      console.log('Selected Index:', selectedIndex);
      console.log('Target Angle:', targetAngle);
      console.log('Current Rotation:', currentRotation);
      console.log('Total Rotation:', totalRotation);

      // 애니메이션 실행
      gsap.to(canvas, {
        rotation: totalRotation,
        duration: 4,
        ease: "power4.out",
        onUpdate: function() {
          // 현재 회전 각도 업데이트 (0~360도로 정규화)
          const currentDeg = ((this.targets()[0].rotation % 360) + 360) % 360;
          canvas.style.transform = `rotate(${currentDeg}deg)`;
        },
        onComplete: () => {
          // 최종 회전 각도 (0~360도)
          const finalRotation = ((totalRotation % 360) + 360) % 360;
          
          // 포인터 위치(12시 방향)에 있는 세그먼트 계산
          // 최종 회전 후 12시 방향(0도)을 기준으로 계산
          const pointerDeg = (360 - (finalRotation % 360)) % 360;
          
          // 각 세그먼트의 중앙 각도와의 차이 계산
          let minDiff = 360;
          let actualIndex = 0;
          
          segments.forEach(segment => {
            // 시계 방향으로의 각도 차이 계산
            let diff = (segment.midAngleDegrees - pointerDeg + 360) % 360;
            // 최소 차이 업데이트
            if (diff < minDiff) {
              minDiff = diff;
              actualIndex = segment.index;
            }
          });
          
          console.log('Selected Index:', selectedIndex, 
                      'Actual Index:', actualIndex, 
                      'Pointer Deg:', pointerDeg.toFixed(2),
                      'Target Deg:', segments[selectedIndex].midAngleDegrees.toFixed(2));
          
          // 디버깅을 위한 로그
          console.log('Selected Index:', selectedIndex);
          console.log('Selected Name:', rouletteItems[selectedIndex]);
          console.log('Final Rotation:', finalRotation);
          console.log('Actual Stopped Index:', actualIndex);
          
          // 최종 확인 알림
          alert(`애니메이션 완료!\n` +
                `선택된 당첨자: [${selectedIndex + 1}] ${rouletteItems[selectedIndex]}\n` +
                `포인터 위치: [${actualIndex + 1}] ${rouletteItems[actualIndex]}\n` +
                `최종 각도: ${finalRotation.toFixed(2)}°`);
                
          showWinner(rouletteItems[selectedIndex], selectedIndex);
        }
      });
    }

    function showWinner(name, index) {
      document.getElementById('popup').innerHTML = `[${index + 1}] ${name}님,<br>당첨입니다!<br>쏘시죠.`;
      document.getElementById('popup').classList.remove('hidden');
      document.getElementById('firework').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('popup').classList.add('hidden');
        document.getElementById('firework').classList.add('hidden');
      }, 3000);
    }

    drawRoulette();
  </script>
</body>
</html>
